{
  "variables":
  {
    "sourceFolders":      "2016,2019,cs,SQL2017,sxs2016,net48,thirdparty,vslayout,SQL2016,OOS",
    "storageRG":          "PwS3-Infra-Storage-RG",
    "storageAccountName": "sharepointbinaries",
    "shareName":          "dsc-share",
    "sastoken" :          null
  },
  "builders": [
    {
      "type": "azure-arm",
      "subscription_id":                    "8e360d0e-2e05-428c-a82b-31fc0835b691",
      "build_resource_group_name":          "PwS3-Infra-Storage-RG",
      "capture_container_name":             "gcshare",
      "capture_name_prefix":                "gcshare_windows_2016",
      "resource_group_name":                "PwS3-Infra-Storage-RG",
      "storage_account":                    "gcsharetemplates",
      "os_type":                            "Windows",
      "image_publisher":                    "MicrosoftWindowsServer",
      "image_offer":                        "WindowsServer",
      "image_sku":                          "2016-Datacenter",
      "image_version":                      "14393.3274.1910061629",
      "communicator":                       "winrm",
      "winrm_use_ssl":                      true,
      "winrm_insecure":                     true,
      "winrm_use_ntlm":                     true,
      "winrm_timeout":                      "10m",
      "winrm_username":                     "packer",
      "azure_tags": {
        "CostCenter":  "PSPC-GCWide",
        "Owner":       "steve.trotman@tpsgc-pwgsc.gc.ca",
        "Program":     "GCshare",
        "Environment": "Sandbox"
      },
      "vm_size": "Standard_D4s_v3"
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "environment_vars": [
        "SASTOKEN={{user `sastoken`}}"
      ],
      "script": "stageAzcopy.ps1" 
    },   
    {
      "type": "powershell",
      "environment_vars": [
        "SASTOKEN={{user `sastoken`}}",
        "SOURCEFOLDERS={{user `sourceFolders`}}"
      ],
      "script": "stageBinaries.ps1" 
    },    
    {
      "type": "windows-update",
      "search_criteria": "IsInstalled=0",
      "filters": [
        "exclude:$_.Title -like '*Preview*'",
        "include:$true"
      ],
      "update_limit": 25
    },
    {
      "type": "powershell",
      "inline": [
        "  while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
        "  while ((Get-Service HealthService).Status -ne 'Running') { Start-Sleep -s 20 }",
        "  while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
        "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit /mode:vm",
        "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
      ]
    }
  ]
}